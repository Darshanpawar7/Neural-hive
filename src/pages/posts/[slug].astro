---
import BaseLayout from "../../layouts/BaseLayout.astro";

export async function getStaticPaths() {
  const modules = import.meta.glob("../../content/posts/*.md");

  const entries = await Promise.all(
    Object.entries(modules).map(async ([, loader]) => {
      const mod: any = await (loader as any)();
      if (!mod?.frontmatter?.slug) return null;

      return {
        params: { slug: mod.frontmatter.slug },
        props: {
          frontmatter: mod.frontmatter,
          Content: mod.default
        }
      };
    })
  );

  return entries.filter(Boolean);
}

const { frontmatter, Content } = Astro.props;

if (!frontmatter) {
  throw new Error("Post not found");
}
---

<BaseLayout title={frontmatter.title} description={frontmatter.description}>
  <article class="prose dark:prose-invert max-w-none">
    <h1>{frontmatter.title}</h1>

    <p class="text-sm text-gray-500 dark:text-gray-400">
      {frontmatter.date} • <span id="readingTime">—</span>
    </p>

    {frontmatter.hero_image ? (
      <img
        src={frontmatter.hero_image}
        alt={frontmatter.title}
        class="rounded border dark:border-gray-800"
      />
    ) : null}

    <div class="mt-6 grid md:grid-cols-3 gap-6">
      <div class="md:col-span-2" id="article">
        <Content />
      </div>

      <aside class="md:col-span-1">
        <div id="toc" class="sticky top-24 text-sm"></div>
      </aside>
    </div>
  </article>

  <script is:inline>
    (function () {
      // Reading time
      const article = document.getElementById("article");
      if (article) {
        const words = (article.innerText || "").trim().split(/\s+/).length;
        const mins = Math.max(1, Math.round(words / 200));
        const rt = document.getElementById("readingTime");
        if (rt) rt.innerText = mins + " min read";
      }

      // Table of Contents
      const toc = document.getElementById("toc");
      if (!article || !toc) return;

      const headings = article.querySelectorAll("h2, h3");
      if (headings.length === 0) {
        toc.innerHTML = "<em>No sections</em>";
        return;
      }

      var html = "<strong>Table of contents</strong><ul style='margin-top:8px'>";
      headings.forEach(function (h) {
        var id = h.innerText
          .toLowerCase()
          .replace(/[^a-z0-9]+/g, "-")
          .replace(/(^-|-$)/g, "");

        h.id = id;

        html +=
          '<li style="margin-bottom:6px"><a href="#' +
          id +
          '" class="underline">' +
          h.innerText +
          "</a></li>";
      });

      html += "</ul>";
      toc.innerHTML = html;
    })();
  </script>
</BaseLayout>
